# Inventory Service Implementation: Phase 1 - Repository Setup & Project Scaffolding

## 1. Overview

This document provides detailed implementation specifications for setting up the **Inventory Service** repository and scaffolding the initial NestJS project structure. This is the first phase of the Inventory Service implementation plan as outlined in [00-implementation-plan-index.md](./00-implementation-plan-index.md).

The Inventory Service will be a NestJS application, developed using TypeScript. It is responsible for managing product stock levels, reservations, and tracking inventory history.

## 2. Prerequisites

- Access to the central Git hosting platform (e.g., GitHub, GitLab).
- Node.js LTS version installed (e.g., v18 or v20+).
- `npm` (or `yarn`) package manager.
- Docker and Docker Compose installed for local development.
- NestJS CLI installed globally: `npm install -g @nestjs/cli`.

## 3. Repository Initialization

1.  **Create a new directory for the service**:
    It's recommended to create this within a monorepo or a dedicated services directory.
    ```bash
    mkdir inventory-service
    cd inventory-service
    ```

2.  **Initialize a new Git repository**:
    ```bash
    git init
    ```

3.  **Connect to the central Git repository**:
    (Replace `[REPOSITORY_URL]` with the actual URL from the Git hosting platform)
    ```bash
    git remote add origin [REPOSITORY_URL]
    # Example: git remote add origin git@github.com:your-org/inventory-service.git
    git branch -M main
    ```
    An empty repository named `inventory-service` should be created on the platform beforehand.

## 4. Project Scaffolding (NestJS)

1.  **Generate a new NestJS project** within the `inventory-service` directory:
    ```bash
    # Ensure you are in the inventory-service directory
    nest new . --strict --package-manager npm --language ts
    ```
    *   `nest new .`: Scaffolds a new project in the current directory.
    *   `--strict`: Enables TypeScript's strict mode.
    *   `--package-manager npm`: Specifies npm as the package manager (can be yarn).
    *   `--language ts`: Ensures the project is generated in TypeScript.

2.  **Default Structure**: NestJS will create a standard project structure, including:
    *   `src/`: Contains the application source code (`main.ts`, `app.module.ts`, etc.).
    *   `test/`: For unit and end-to-end tests.
    *   `node_modules/`: Project dependencies.
    *   `.eslintrc.js`, `.prettierrc.json`, `tsconfig.json`, `package.json`, etc.

## 5. Initial Files

### 5.1. `.gitignore`

A standard Node.js `.gitignore` file will be generated by NestJS. Ensure it includes common exclusions:
```gitignore
# Dependencies
/node_modules
/.pnp
.pnp.js

# Venv
.venv

# Compiled output
/dist
/build

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*
*.lck

# OS generated files
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# IDEs and editors
/.idea
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json

# Environment variables
.env
.env.test
.env.production
.env*.local
!.env.example

# Docker
docker-compose.override.yml
docker/data/
pg_data/

# Optional NestJS files
generated/

# Coverage
coverage
```
This is a comprehensive example; the one generated by NestJS should be a good starting point.

### 5.2. `README.md`

The NestJS CLI generates a basic `README.md`. Update it to be specific to the Inventory Service:
```markdown
# Inventory Service

## Description

The Inventory Service is a microservice for the e-commerce platform, responsible for:
- Managing real-time stock levels for product variants.
- Handling inventory reservations and releases.
- Tracking history of all inventory movements.

This service integrates with the Product Service, Order Service, and potentially others.

## Technology Stack

- **Framework**: NestJS
- **Language**: TypeScript
- **Database**: PostgreSQL (via Amazon RDS in production, as per ADR-004)
- **ORM**: TypeORM
- **Messaging**: RabbitMQ (via Amazon MQ in production, as per ADR-018)
- **Containerization**: Docker
- **API Specification**: OpenAPI (Swagger)

## Getting Started

### Prerequisites

- Node.js (Version specified in `.nvmrc` or project root)
- npm (or yarn)
- Docker & Docker Compose (for local development)
- Access to common platform services (Database, Message Broker)

### Installation

```bash
# Clone the repository (if not already done)
# git clone [REPOSITORY_URL]
# cd inventory-service

# Install dependencies
npm install
```

## Running Locally

```bash
# Development mode (with watch)
npm run start:dev

# Production mode (after build)
# npm run build
# npm run start:prod
```
The service will typically run on port 3005.

## Testing

```bash
# Unit tests
npm run test

# E2E tests
npm run test:e2

# Test coverage
npm run test:cov
```

## API Documentation

When running in development mode, Swagger API documentation (if configured) is typically available at:
- `http://localhost:3005/api/docs` (or the configured API prefix)

## Environment Variables

Refer to `.env.example` for required environment variables. A local `.env` file will need to be created with appropriate values for development.

## Next Steps

Further development will involve:
- Data model and database setup ([02-data-model-setup.md](./02-data-model-setup.md))
- Implementation of core service components ([03-core-service-components.md](./03-core-service-components.md))
- API endpoint definition and implementation ([04-api-layer.md](./04-api-layer.md))
```

### 5.3. Linting and Formatting

NestJS generates default configurations for ESLint (`.eslintrc.js`) and Prettier (`.prettierrc.json`). These should align with overall project standards. An `.editorconfig` file might also be present or added for editor consistency.

Example `.editorconfig` (if not generated):
```editorconfig
root = true

[*]
indent_style = space
indent_size = 2
end_of_line = lf
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true

[*.md]
trim_trailing_whitespace = false
```

## 6. Dockerization

### 6.1. `Dockerfile`

Create a multi-stage `Dockerfile` in the root directory:
```dockerfile
# ---- Builder Stage ----
FROM node:18-alpine AS builder

WORKDIR /usr/src/app

# Copy package files and install dependencies
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force
# If you have devDependencies needed for build (e.g. specific TypeScript tools not in Nest CLI)
# RUN npm ci && npm cache clean --force

COPY . .

# Build the application
RUN npm run build

# ---- Runtime Stage ----
FROM node:18-alpine AS runtime

WORKDIR /usr/src/app

# Set NODE_ENV to production
ENV NODE_ENV production

# Copy production dependencies from builder stage
COPY --from=builder /usr/src/app/node_modules ./node_modules
COPY --from=builder /usr/src/app/package*.json ./

# Copy compiled application from builder stage
COPY --from=builder /usr/src/app/dist ./dist

# Expose the application port (as defined in OpenAPI spec and .env)
EXPOSE 3005

# Command to run the application
CMD ["node", "dist/main.js"]
```

### 6.2. `docker-compose.yml` (for local development)

Create a `docker-compose.yml` for local development convenience.
(Note: ADR-046 might specify a top-level Docker Compose for inter-service dependencies. This file focuses on the Inventory Service itself, possibly with its direct database if not managed centrally.)

```yaml
version: '3.8'

services:
  inventory-service:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder # Use builder for dev to include devDependencies for hot-reloading
    container_name: inventory_service_dev
    ports:
      - "3005:3005" # Expose Inventory Service port
    volumes:
      - .:/usr/src/app # Mount current directory for hot-reloading
      - /usr/src/app/node_modules # Avoids overwriting node_modules in container
    command: npm run start:dev # Command to run in development mode
    env_file:
      - .env # Load environment variables from .env file
    depends_on: # Optional: if running DB/Broker via this compose
      - inventory_postgres_db
      - inventory_rabbitmq
    networks:
      - inventory_network

  inventory_postgres_db: # Example: if managing DB locally with this service's compose
    image: postgres:14-alpine
    container_name: inventory_postgres_db_dev
    ports:
      - "5435:5432" # Map to a different host port if 5432 is in use
    environment:
      POSTGRES_USER: inventory_user
      POSTGRES_PASSWORD: inventory_password
      POSTGRES_DB: inventory_db
    volumes:
      - inventory_pg_data:/var/lib/postgresql/data
    networks:
      - inventory_network

  inventory_rabbitmq: # Example: if managing RabbitMQ locally
    image: rabbitmq:3-management-alpine
    container_name: inventory_rabbitmq_dev
    ports:
      - "5673:5672" # Management UI on 15673
      - "15673:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      - inventory_network

volumes:
  inventory_pg_data:
    driver: local

networks:
  inventory_network:
    driver: bridge
```
**Note**: The port for Inventory Service is 3005. For PostgreSQL and RabbitMQ, different ports (5435, 5673, 15673) are used on the host to avoid conflicts if other services use the defaults.

### 6.3. `.dockerignore`

Create a `.dockerignore` file:
```dockerignore
# Git
.git
.gitignore

# Node modules
node_modules

# Compiled output (if not needed in builder context for some reason)
# dist
# build

# OS generated files
.DS_Store
Thumbs.db

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*

# Environment files (should be passed via docker-compose or k8s secrets)
.env
.env.*
!.env.example

# Docker specific
Dockerfile
docker-compose.yml
.dockerignore
```

## 7. Key Dependencies

The following key npm packages will be required. Many core NestJS packages are installed by `nest new`. Others will be added as features are implemented:

*   **Core NestJS**:
    *   `@nestjs/common`, `@nestjs/core`, `@nestjs/platform-express` (default)
    *   `reflect-metadata`, `rxjs`
*   **Database (PostgreSQL & TypeORM)**:
    *   `pg` (PostgreSQL driver)
    *   `typeorm`
    *   `@nestjs/typeorm`
*   **Messaging (RabbitMQ)**:
    *   `amqplib` (RabbitMQ client library)
    *   `amqp-connection-manager` (for robust connections)
    *   `@nestjs/microservices` (if using NestJS's RabbitMQ transport layer)
*   **Configuration**:
    *   `@nestjs/config` (for managing environment variables)
    *   `joi` (for environment variable validation, often used with `@nestjs/config`)
*   **Validation**:
    *   `class-validator`
    *   `class-transformer`
*   **API Documentation**:
    *   `@nestjs/swagger` (for OpenAPI/Swagger documentation)
*   **Development Dependencies**:
    *   `@nestjs/cli`, `@nestjs/schematics`
    *   `@types/node`, `@types/express`, `@types/jest`
    *   `typescript`, `eslint`, `prettier`, `jest`, `supertest` (for E2E tests)

These will be installed via `npm install <package_name>` or `npm install --save-dev <package_name>`.

## 8. Initial Commit

Once the basic structure, initial files, and Docker setup are in place:
```bash
git add .
git commit -m "feat: initial repository and NestJS project setup for Inventory Service"
# If the remote 'origin' and 'main' branch are set up:
# git push -u origin main
```

## 9. Next Steps

With the repository and basic project structure established, the subsequent steps will involve:
1.  **Data Model and Database Setup**: Defining entities, configuring TypeORM, and setting up database migrations (as per [02-data-model-setup.md](./02-data-model-setup.md)).
2.  **Core Service Logic**: Implementing the `InventoryManagerService`, `ReservationManagerService`, and `InventoryHistoryService` (as per [03-core-service-components.md](./03-core-service-components.md)).
3.  **API Layer**: Building the RESTful API endpoints (as per [04-api-layer.md](./04-api-layer.md) and the OpenAPI spec).

This foundational setup ensures a consistent and maintainable structure for the Inventory Service.
```
