# Notification Service Implementation: Phase 1 - Repository Setup & Project Scaffolding

## 1. Overview

*   **Purpose**: This document provides detailed implementation specifications for setting up the **Notification Service** repository and scaffolding the initial NestJS project structure. This is the first phase of the Notification Service implementation plan as outlined in [00-implementation-plan-index.md](./00-implementation-plan-index.md).
*   **Technology**: The Notification Service will be a NestJS application, developed using TypeScript. It is designed to handle all outgoing communications (Email, SMS, Push Notifications) for the e-commerce platform.

## 2. Repository Initialization

1.  **Create a new directory for the service**:
    It's recommended to create this within a monorepo or a dedicated services directory.
    ```bash
    mkdir notification-service
    cd notification-service
    ```

2.  **Initialize a new Git repository**:
    ```bash
    git init
    ```

3.  **Connect to the central Git repository**:
    (Replace `[REPOSITORY_URL]` with the actual URL from the Git hosting platform)
    ```bash
    git remote add origin [REPOSITORY_URL]
    # Example: git remote add origin git@github.com:your-org/notification-service.git
    git branch -M main
    ```
    An empty repository named `notification-service` should be created on the platform beforehand.

## 3. Project Scaffolding (NestJS)

1.  **Generate a new NestJS project** within the `notification-service` directory:
    ```bash
    # Ensure you are in the notification-service directory
    nest new . --strict --package-manager npm --language ts
    ```
    *   `nest new .`: Scaffolds a new project in the current directory.
    *   `--strict`: Enables TypeScript's strict mode.
    *   `--package-manager npm`: Specifies npm as the package manager (can be yarn).
    *   `--language ts`: Ensures the project is generated in TypeScript.

2.  **Default Structure**: NestJS will create a standard project structure, including:
    *   `src/`: Contains the application source code (`main.ts`, `app.module.ts`, etc.).
    *   `test/`: For unit and end-to-end tests.
    *   `node_modules/`: Project dependencies.
    *   `.eslintrc.js`, `.prettierrc.json`, `tsconfig.json`, `package.json`, etc.

## 4. Initial Files

### 4.1. `.gitignore`

A standard Node.js `.gitignore` file will be generated by NestJS. Ensure it is comprehensive. Example content:
```gitignore
# Dependencies
/node_modules
/.pnp
.pnp.js
.DS_Store

# Venv
.venv

# Compiled output
/dist
/build

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*
*.lck

# OS generated files
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# IDEs and editors
/.idea
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json

# Environment variables
.env
.env.test
.env.production
.env*.local
!.env.example

# Docker
docker-compose.override.yml
docker/data/
pg_data_notification/ # If PostgreSQL is used locally for this service

# Optional NestJS files
generated/

# Coverage
coverage
```

### 4.2. `README.md`

The NestJS CLI generates a basic `README.md`. Update it to be specific to the Notification Service:
```markdown
# Notification Service

## Description

The Notification Service is a microservice for the e-commerce platform, responsible for managing and dispatching all outgoing communications to users and internal systems. This includes:
- Sending emails (e.g., order confirmations, password resets) via providers like AWS SES.
- Sending SMS messages (e.g., shipping updates) via providers like Twilio.
- Sending push notifications (e.g., new alerts) via providers like AWS SNS (to FCM/APNS).

It primarily consumes events from other services to trigger notifications.

## Technology Stack

- **Framework**: NestJS
- **Language**: TypeScript
- **Messaging**: RabbitMQ (via Amazon MQ in production, as per ADR-018)
- **Email Provider**: AWS SES (as per ADR-042)
- **SMS Provider**: Twilio
- **Push Notification Provider**: AWS SNS (as per ADR-042)
- **Templating**: Handlebars
- **Database (Optional)**: PostgreSQL (for notification history/templates, if implemented, as per ADR-004)
- **Containerization**: Docker
- **API Specification**: OpenAPI (Swagger)

## Getting Started

### Prerequisites

- Node.js (Version specified in `.nvmrc` or project root)
- npm (or yarn)
- Docker & Docker Compose (for local development)

### Installation

```bash
npm install
```

## Running Locally

```bash
# Development mode (with watch)
npm run start:dev
```
The service will typically run on port 3006 (see `docker-compose.yml` and `.env`).

## Testing

```bash
# Unit tests
npm run test

# E2E tests (if applicable, typically against mocked providers)
npm run test:e2e

# Test coverage
npm run test:cov
```

## API Documentation

If the service exposes a synchronous API (e.g., for manual triggering or status checks), Swagger documentation (if configured) is typically available at:
- `http://localhost:3006/api/docs`

## Environment Variables

Refer to `.env.example` for required environment variables. A local `.env` file will need to be created with appropriate values for development, including API keys for channel providers.

## Next Steps

- Data model design (if storing templates/history) - [02-data-model-setup.md](./02-data-model-setup.md)
- Core service component implementation - [03-core-service-components.md](./03-core-service-components.md)
- API layer design (if applicable) - [04-api-layer.md](./04-api-layer.md)
- Event consumption setup - [05-event-consumption.md](./05-event-consumption.md)
```

### 4.3. Linting and Formatting

NestJS generates default configurations for ESLint (`.eslintrc.js`) and Prettier (`.prettierrc.json`). An `.editorconfig` file is also recommended:
```editorconfig
root = true

[*]
indent_style = space
indent_size = 2
end_of_line = lf
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true

[*.md]
trim_trailing_whitespace = false
```

## 5. Dockerization

### 5.1. `Dockerfile`

Create a multi-stage `Dockerfile` in the root directory:
```dockerfile
# ---- Builder Stage ----
FROM node:18-alpine AS builder

WORKDIR /usr/src/app

# Copy package files and install dependencies
# Using npm ci for cleaner installs, ensure package-lock.json is present
COPY package*.json ./
RUN npm ci

COPY . .

# Build the application
RUN npm run build

# ---- Runtime Stage ----
FROM node:18-alpine AS runtime

WORKDIR /usr/src/app

# Set NODE_ENV to production
ENV NODE_ENV production

# Copy production dependencies from builder stage (pruned)
# Only copy node_modules if not already handled by a more specific "npm ci --only=production"
COPY --from=builder /usr/src/app/node_modules ./node_modules
COPY --from=builder /usr/src/app/package*.json ./

# Copy compiled application from builder stage
COPY --from=builder /usr/src/app/dist ./dist

# Expose the application port (3006 as per OpenAPI spec)
EXPOSE 3006

# Command to run the application
CMD ["node", "dist/main.js"]
```

### 5.2. `docker-compose.yml` (for local development)

```yaml
version: '3.8'

services:
  notification-service:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder # Use builder for dev to include devDependencies for hot-reloading
    container_name: notification_service_dev
    ports:
      - "3006:3006" # Notification Service port
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
    command: npm run start:dev
    env_file:
      - .env # Load environment variables from .env file
    depends_on:
      - notification_rabbitmq # Essential dependency
      # - notification_postgres_db # Optional: if service stores data (templates/history)
    networks:
      - notification_network

  notification_rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: notification_rabbitmq_dev
    ports:
      - "5674:5672" # Host port 5674 to avoid conflict
      - "15674:15672" # Management UI on host port 15674
    environment:
      RABBITMQ_DEFAULT_USER: guest # Use actual credentials from .env in real setup
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - notification_rabbitmq_data:/var/lib/rabbitmq/
    networks:
      - notification_network

  # Optional: PostgreSQL database if Notification Service stores templates or history
  # notification_postgres_db:
  #   image: postgres:14-alpine
  #   container_name: notification_postgres_db_dev
  #   ports:
  #     - "5436:5432" # Host port 5436 to avoid conflict
  #   environment:
  #     POSTGRES_USER: notification_user
  #     POSTGRES_PASSWORD: notification_password
  #     POSTGRES_DB: notification_db
  #   volumes:
  #     - notification_pg_data:/var/lib/postgresql/data
  #   networks:
  #     - notification_network

volumes:
  notification_rabbitmq_data:
    driver: local
  # notification_pg_data: # Uncomment if using PostgreSQL
  #   driver: local

networks:
  notification_network:
    driver: bridge
```
**Note**:
*   Notification Service port: 3006.
*   RabbitMQ ports: 5674 (AMQP), 15674 (Management UI) to avoid conflicts.
*   PostgreSQL (if used) ports: 5436 to avoid conflicts.
*   `.env` file should contain actual credentials and connection strings:
    *   `RABBITMQ_URL=amqp://guest:guest@notification_rabbitmq:5672` (example for within Docker network)
    *   `DATABASE_URL=postgresql://notification_user:notification_password@notification_postgres_db:5432/notification_db` (if PostgreSQL is used)
    *   API keys for AWS SES, Twilio, AWS SNS (as per ADR-016, these will be managed via environment variables).

### 5.3. `.dockerignore`

```dockerignore
# Git
.git
.gitignore

# Node modules
node_modules

# Compiled output
dist
build

# OS generated files
.DS_Store
Thumbs.db

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*

# Environment files (should be passed via docker-compose or k8s secrets/configmaps)
.env
.env.*
!.env.example

# Docker specific (these files are used to build/run, not to be copied into image)
Dockerfile
docker-compose.yml
.dockerignore
```

## 6. Key Dependencies (npm/yarn)

The following key npm packages will be required. Many core NestJS packages are installed by `nest new`.

*   **Core NestJS**:
    *   `@nestjs/common`, `@nestjs/core`, `@nestjs/platform-express`
    *   `reflect-metadata`, `rxjs`
*   **Messaging (RabbitMQ)**:
    *   `amqplib`
    *   `amqp-connection-manager` (recommended for robust connections)
    *   `@nestjs/microservices` (if using NestJS RabbitMQ transport)
*   **Configuration**:
    *   `@nestjs/config`
    *   `joi` (for environment variable validation)
*   **Validation**:
    *   `class-validator`, `class-transformer`
*   **Channel SDKs**:
    *   `@aws-sdk/client-ses` (for AWS SES - Email)
    *   `@aws-sdk/client-sns` (for AWS SNS - Push)
    *   `twilio` (for Twilio - SMS)
*   **Templating**:
    *   `handlebars`
*   **Database (Optional - if storing templates/history/logs)**:
    *   `@nestjs/typeorm`
    *   `typeorm`
    *   `pg` (PostgreSQL driver)
*   **API Documentation (if service has API endpoints)**:
    *   `@nestjs/swagger`
*   **Development Dependencies**:
    *   `@nestjs/cli`, `@nestjs/schematics`, `@types/node`, `@types/express`, `@types/jest`, `@types/amqplib`
    *   `typescript`, `eslint`, `prettier`, `jest`, `supertest`

These will be installed via `npm install <package_name>` or `npm install --save-dev <package_name>` as development progresses.

## 7. Next Steps

With the repository and basic project structure established, the subsequent steps will involve:
1.  **Data Model and Database Setup (if applicable)**: Defining entities for notification logs, templates, or preferences ([02-data-model-setup.md](./02-data-model-setup.md)).
2.  **Core Service Logic**: Implementing components for event consumption, dispatching, template management, and channel integration ([03-core-service-components.md](./03-core-service-components.md)).
3.  **API Layer (if applicable)**: Building any RESTful API endpoints ([04-api-layer.md](./04-api-layer.md) and [10-openapi-specification.md](./openapi/notification-service.yaml)).
4.  **Event Consumption**: Setting up listeners for relevant events from other services ([05-event-consumption.md](./05-event-consumption.md)).
5.  **Channel Integrations**: Detailed implementation for SES, Twilio, SNS ([06-channel-integrations.md](./06-channel-integrations.md)).

This foundational setup provides a solid starting point for the Notification Service.
